From 9cefe7d486462de3a7ad458966c20ef30fd0d2a7 Mon Sep 17 00:00:00 2001
From: "freedom.tan" <freedom.tan@mediatek.com>
Date: Wed, 11 Nov 2015 17:20:56 +0800
Subject: [PATCH 4/4] report 4 thermal zones instead of 1

a thermal zone for each bank makes more sense to me
---
 arch/arm64/boot/dts/mediatek/mt8173.dtsi |  2 +-
 drivers/thermal/mtk_thermal.c            | 26 ++++++++++----------------
 2 files changed, 11 insertions(+), 17 deletions(-)

diff --git a/arch/arm64/boot/dts/mediatek/mt8173.dtsi b/arch/arm64/boot/dts/mediatek/mt8173.dtsi
index 9af62af..29ebf03 100644
--- a/arch/arm64/boot/dts/mediatek/mt8173.dtsi
+++ b/arch/arm64/boot/dts/mediatek/mt8173.dtsi
@@ -714,7 +714,7 @@
 		};
 
 		thermal: thermal@1100b000 {
-			#thermal-sensor-cells = <0>;
+			#thermal-sensor-cells = <1>;
 			compatible = "mediatek,mt8173-thermal";
 			reg = <0 0x1100b000 0 0x1000>;
 			interrupts = <0 70 IRQ_TYPE_LEVEL_LOW>;
diff --git a/drivers/thermal/mtk_thermal.c b/drivers/thermal/mtk_thermal.c
index 262ab0a..5e42067 100644
--- a/drivers/thermal/mtk_thermal.c
+++ b/drivers/thermal/mtk_thermal.c
@@ -123,6 +123,7 @@ struct mtk_thermal;
 
 struct mtk_thermal_bank {
 	struct mtk_thermal *mt;
+	struct thermal_zone_device *tz;
 	int id;
 };
 
@@ -295,21 +296,11 @@ static int mtk_thermal_bank_temperature(struct mtk_thermal_bank *bank)
 
 static int mtk_read_temp(void *data, int *temperature)
 {
-	struct mtk_thermal *mt = data;
-	int i;
-	int tempmax = INT_MIN;
-
-	for (i = 0; i < MT8173_NUM_ZONES; i++) {
-		struct mtk_thermal_bank *bank = &mt->banks[i];
+	struct mtk_thermal_bank *bank = data;
 
-		mtk_thermal_get_bank(bank);
-
-		tempmax = max(tempmax, mtk_thermal_bank_temperature(bank));
-
-		mtk_thermal_put_bank(bank);
-	}
-
-	*temperature = tempmax;
+	mtk_thermal_get_bank(bank);
+	*temperature = mtk_thermal_bank_temperature(bank);
+	mtk_thermal_put_bank(bank);
 
 	return 0;
 }
@@ -571,8 +562,11 @@ static int mtk_thermal_probe(struct platform_device *pdev)
 
 	platform_set_drvdata(pdev, mt);
 
-	devm_thermal_zone_of_sensor_register(&pdev->dev, 0, mt,
-					     &mtk_thermal_ops);
+	for (i = 0; i < MT8173_NUM_ZONES; i++) {
+		struct mtk_thermal_bank *bank = &mt->banks[i];
+		bank->tz = devm_thermal_zone_of_sensor_register(&pdev->dev,
+			i, bank, &mtk_thermal_ops);
+	}
 
 	return 0;
 
-- 
2.7.4

